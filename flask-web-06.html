<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>Flask Web 开发学习笔记（六）</title>
    <meta name="description" content="Stay hungry, stay foolish." />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="http://localhost:4000//flask-web-06" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Yiming's Blog" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Flask Web 开发学习笔记（六）" />
    <meta property="og:description" content="Stay hungry, stay foolish." />
    <meta property="og:url" content="http://localhost:4000//flask-web-06" />
    <meta property="og:image" content="/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Flask Web 开发学习笔记（六）" />
    <meta name="twitter:description" content="Stay hungry, stay foolish." />
    <meta name="twitter:url" content="http://localhost:4000//flask-web-06" />
    <meta name="twitter:image:src" content="/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Yiming's Blog",
    "name": "Flask Web 开发学习笔记（六）",
    "url": "http://localhost:4000//flask-web-06",
    "image": "/assets/images/cover1.jpg",
    "description": "Stay hungry, stay foolish."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Yiming's Blog" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        <li class="nav-fables " role="presentation"><a href="/tag/fables">Fables</a></li>
        <li class="nav-speeches " role="presentation"><a href="/tag/speeches">Speeches</a></li>
        <li class="nav-fiction " role="presentation"><a href="/tag/fiction">Fiction</a></li>
        <li class="nav-author " role="presentation"><a href="/author/casper">Casper</a></li>
        <li class="nav-author " role="presentation"><a href="/author/edgar">Edgar</a></li>
        <li class="nav-author " role="presentation"><a href="/author/abraham">Abraham</a></li>
        <li class="nav-author " role="presentation"><a href="/author/martin">Martin</a></li>
        <li class="nav-author " role="presentation"><a href="/author/lewis">Lewis</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/cover1.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/ghost.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-speeches">

        <header class="post-header">
            <h1 class="post-title">Flask Web 开发学习笔记（六）</h1>
            <section class="post-meta">
            <!-- <a href='/'></a> -->

            
                
            
                
            
                
            
                
            
                
            
            <time class="post-date" datetime="2015-04-08">08 Apr 2015</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/Python'>Python</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>本文主要介绍如何使用 Flask 操作数据库。</p>

<p>数据库按照一定规则保存程序数据，程序再发起查询取回所需的数据。Web 程序最常用基于关系模型的数据库，这种数据库也称为 SQL 数据，因为它们使用结构化查询语句。不过最近几年文档数据库和键值对数据库成了流行的替代选择，这两种数据库合称为 NoSQL 数据库。</p>

<p>大多数的数据库引擎都有对应的 Python 包，包括开源包和商业包。Flask 并不限制你使用何种类型的数据库包，因此可以根据自己的喜好选择使用 MySQL、Postgres、SQLite，Redis、MongoDB 或者 CouchDB。</p>

<p>如果这些都无法满足需求，还有一些数据库抽象层代码包供选择，例如 SQLAlchemy 和 MongoEngine 。你可以使用这些抽象包直接处理高等级的 Python 对象，而不用处理如表、文档或查询语言此类的数据库实体。</p>

<p>选择框架时，你不一定非得选择已经集成了 Flask 的框架，但选择这些框架可以节约你编写集成代码的时间。使用集成了 Flask 的框架可以简化配置和操作，所以专门为 Flask 开发的扩展是你的首选。</p>

<p>关于选择使用的数据库框架，选择的是 Flask-SQLAlchemy。</p>

<h2 id="安装-flask-sqlalchemy">安装 Flask-SQLAlchemy</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install flask-sqlalchemy
</code></pre></div></div>

<h2 id="配置-flask-sqlalchemy">配置 Flask-SQLAlchemy</h2>

<p>在 Flask-SQLAlchemy 中，数据库使用 URL 指定。</p>

<blockquote>
  <p>MySQL :  mysql://username:password@hostname/database
Postgres ：  postgresql://username:password@hostname/database
SQLite : sqlite:////absolute/path/to/database</p>
</blockquote>

<p>在这些 URL 中，hostname 表示 MySQL 服务所在的主机，可以是本地主机（localhost），也可以是远程服务器。数据库服务器上可以托管多个数据库，因此 database 表示要使用的数据库名。如果数据库需要进行认证，username 和 password 表示数据库的用户名和密码。</p>

<p>SQLite 数据库不需要使用服务器，因此不用指定 hostname、username 和 password。 URL 中的 database 是硬盘上文件的文件名。</p>

<p>程序使用的数据库URL必须保存到 Flask 配置对象的 <code class="highlighter-rouge">SQLALCHEMY_DATABASE_URI</code> 键中。配置对象中还有一个很有用的选项，即 <code class="highlighter-rouge">SQLALCHEMY_COMMIT_ON_TEARDOWN</code> 键，将其设置为 <code class="highlighter-rouge">True</code> 时，每次请求结束后都会自动提交数据库中的变动。</p>

<p>我们使用 SQLite 数据库，配置代码 如下：</p>

<pre><code class="language-PYTHON">from flask import Flask
from flask_sqlalchemy import SQLAlchemy
import os  

baseDir = os.path.abspath(os.path.dirname(__file__))

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] ='sqlite:////' + os.path.join(baseDir,'data.sqlite')
app.config['SQLALCHEMY_COMMIT_ON_TEARDOWN'] = True

db = SQLAlchemy(app)
</code></pre>

<h2 id="定义模型">定义模型</h2>

<p>定义一个用户表 users 和一个角色表 roles，代码如下：</p>

<pre><code class="language-PYTHON">class User(db.Model):
    __tablename__ = 'users'
    id = db.Column(db.Integer,primary_key=True)
    username = db.Column(db.String(64),unique=True,index=True)

    def __repr__(self):
        return '&lt;User %r&gt;' % self.username


class Role(db.Model):
    __tablename__ = 'roles'
    id = db.Column(db.Integer,primary_key=True)
    name = db.Column(db.String(64),unique=True)

    def __repr__(self):
        return '&lt;Role %r&gt;' % self.name
</code></pre>

<p>解释下：</p>

<blockquote>
  <p>0.两个类 <code class="highlighter-rouge">User</code> 和 <code class="highlighter-rouge">Role</code> 继承自 <code class="highlighter-rouge">db.Model</code><br />
1.<code class="highlighter-rouge">__tablename__</code> 用来指定表名称<br />
2.<code class="highlighter-rouge">db.Column()</code> 函数指定了数据库中字段的类型，是否是主键（ <code class="highlighter-rouge">primary_key</code> ），是否唯一( <code class="highlighter-rouge">unique</code> )，是否加索引( <code class="highlighter-rouge">index</code> ),还有其他的比如：是否可以为空（ <code class="highlighter-rouge">nullable=True</code> ）,默认值（ <code class="highlighter-rouge">default</code> ）</p>
</blockquote>

<h2 id="关系">关系</h2>

<p>使用关系型数据库，不指定关系怎么能行。定义模型中我们没有指定关系，一个用户有一个角色，一个角色可以属于多个用户，典型的一对多的关系，如何在 Flask-SQLAlchemy 中定义关系？</p>

<p>上代码：</p>

<pre><code class="language-PYTHON">class User(db.Model):
    __tablename__ = 'users'
    id = db.Column(db.Integer,primary_key=True)
    username = db.Column(db.String(64),unique=True,index=True)

    role_id = db.Column(db.Integer,db.ForeignKey('roles.id'))

    def __repr__(self):
        return '&lt;User %r&gt;' % self.username


class Role(db.Model):
    __tablename__ = 'roles'
    id = db.Column(db.Integer,primary_key=True)
    name = db.Column(db.String(64),unique=True)

    users = db.relationship('User',backref='role')


    def __repr__(self):
        return '&lt;Role %r&gt;' % self.name
</code></pre>

<p>添加了两行代码：</p>

<p>第一行 <code class="highlighter-rouge">User</code> 类中：</p>

<pre><code class="language-PYTHON">role_id = db.Column(db.Integer,db.ForeignKey('roles.id'))
</code></pre>

<p>这句话比较好理解，和上面普通变量差不多，就是 <code class="highlighter-rouge">User</code> 类中添加了一个 <code class="highlighter-rouge">role_id</code> 变量，数据类型 <code class="highlighter-rouge">db.Integer</code>,第二个参数指定外键是哪个表中哪个 <code class="highlighter-rouge">id</code>。</p>

<p>第二行 <code class="highlighter-rouge">Role</code> 类中：</p>

<pre><code class="language-PYTHON"> users = db.relationship('User',backref='role')
</code></pre>

<p>这句话比较复杂，仔细读下面的话：</p>

<blockquote>
  <p>0.添加到 <code class="highlighter-rouge">Role</code> 模型中的 <code class="highlighter-rouge">users</code> 属性代表这个关系的面向对象视角。对于一个 <code class="highlighter-rouge">Role</code> 类的实例，其 <code class="highlighter-rouge">users</code> 属性将返回与角色相关联的用户组成的列表。
1.<code class="highlighter-rouge">db.relationship()</code> 第一个参数表明这个关系的另一端是哪个模型（类）。如果模型类尚未定义，可使用字符串形式指定。
2.<code class="highlighter-rouge">db.relationship()</code> 第二个参数 <code class="highlighter-rouge">backref</code>，将向 <code class="highlighter-rouge">User</code> 类中添加一个 <code class="highlighter-rouge">role</code> 属性，从而定义反向关系。这一属性可替代 <code class="highlighter-rouge">role_id</code> 访问 <code class="highlighter-rouge">Role</code> 模型，此时获取的是模型对象，而不是外键的值。</p>
</blockquote>

<p>上面的关系为一对多关系的表示，一对一怎么办？</p>

<p>调用 <code class="highlighter-rouge">db.relationship()</code> 时需要把 <code class="highlighter-rouge">uselist</code> 参数设置为 <code class="highlighter-rouge">False</code>。如下：</p>

<pre><code class="language-PYTHON">db.relationship('User',backref='role',uselist=False)
</code></pre>
<p>至于多对多关系，以后会慢慢介绍。</p>

<h2 id="数据库操作">数据库操作</h2>

<p>数据库操作，基本的一些：数据库、表创建或删除，数据的增删改查。</p>

<h4 id="创建数据库和表">创建数据库和表</h4>

<pre><code class="language-PYTHON">db.create_all()
</code></pre>

<p>上面说的 users 表和 roles 表就创建了。</p>

<h4 id="删除数据库">删除数据库</h4>

<pre><code class="language-PYTHON">db.drop_all()
</code></pre>

<h4 id="插入行">插入行</h4>

<pre><code class="language-PYTHON">role_admin = Role(name='Admin')
user_tom = User(username='tom',role=role_admin)
user_jim = User(username='jim',role=role_admin)
user_tim = User(username='tim',role=role_admin)
user_sam = User(username='sam',role=role_admin)
db.session.add(role_admin)
db.session.add(user_tom)
db.session.add(user_jim)
db.session.commit()
</code></pre>

<p>通过数据库会话管理对数据库所做的改动，在 Flask-SQLAlchemy 中，会话由<code class="highlighter-rouge">db.session</code> 表示，准备把队形写入数据库之前，先要将其添加到会话中。写入数据库需要调用 <code class="highlighter-rouge">db.session.commit()</code> 方法。</p>

<h4 id="修改行">修改行</h4>

<pre><code class="language-PYTHON"># 我们将 role_admin 变量中 name 为 Admin 改成 Administrator。 

role_admin.name = 'Administrator'
db.session.add(role_admin)
db.session.commit()
</code></pre>

<h4 id="删除行">删除行</h4>

<pre><code class="language-PYTHON"># 删除 Jim 用户

db.session.delete(user_jim)
db.session.commit()
</code></pre>

<h4 id="查询行">查询行</h4>

<pre><code class="language-PYTHON"># 查询所有用户
User.query.all() #返回结果：[&lt;User 'tom'&gt;, &lt;User 'tim'&gt;, &lt;User 'sam'&gt;]
</code></pre>

<p>更多相关方面文档请参考：<a href="http://docs.sqlalchemy.org"> SQLAlchemy 文档</a></p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
            
                
            
                
            
                
            
                
            

            <!-- Add Disqus Comments -->
            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/cover1.jpg)" href="/flask-web-05">
            <section class="post">
                <h2>Flask Web 开发学习笔记（五）</h2>
                <p>本文主要介绍，如何使用 Flask-Mail 发送邮件。 Flask-Mail 连接到简单邮件传输协议（SMTP）服务器，并把邮件交给这个服务器发送。如果不进行配置，Flask-Mail 会连接 localhost 上的端口 25，无需验证即可发送邮件。 安装 Flask-Mail pip install flask-mail Flask-Mail...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Yiming's Blog</a> &copy; 2018</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-69281367-1', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
